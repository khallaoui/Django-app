{% extends 'stock_debord/base.html' %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuration for French locale
    flatpickr.localize(flatpickr.l10ns.fr);
    
    // Date picker for date_debut
    flatpickr("#date_debut", {
        dateFormat: "d/m/Y",
        allowInput: true,
        locale: "fr",
        placeholder: "DD/MM/YYYY",
        onReady: function(selectedDates, dateStr, instance) {
            instance.element.addEventListener('click', function() {
                instance.open();
            });
        }
    });
    
    // Date picker for date_fin
    flatpickr("#date_fin", {
        dateFormat: "d/m/Y",
        allowInput: true,
        locale: "fr",
        placeholder: "DD/MM/YYYY",
        onReady: function(selectedDates, dateStr, instance) {
            instance.element.addEventListener('click', function() {
                instance.open();
            });
        }
    });
    
    // Calendar button handlers
    document.getElementById('date_debut_btn').addEventListener('click', function() {
        document.getElementById('date_debut')._flatpickr.open();
    });
    
    document.getElementById('date_fin_btn').addEventListener('click', function() {
        document.getElementById('date_fin')._flatpickr.open();
    });
    
    // Auto-submit form on Enter key in search field
    document.getElementById('search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            this.form.submit();
        }
    });
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Historique des Entrées/Sorties
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Filtres de recherche -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-filter me-2"></i>Filtres de recherche
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form method="get" class="row g-3">
                                        <div class="col-md-3">
                                            <label for="search" class="form-label">Recherche</label>
                                            <input type="text" class="form-control" id="search" name="search" 
                                                   value="{{ request.GET.search }}" placeholder="Référence, utilisateur...">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="type_action" class="form-label">Type</label>
                                            <select class="form-select" id="type_action" name="type_action">
                                                <option value="">Tous</option>
                                                <option value="entree" {% if request.GET.type_action == 'entree' %}selected{% endif %}>Entrée</option>
                                                <option value="sortie" {% if request.GET.type_action == 'sortie' %}selected{% endif %}>Sortie</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="date_debut" class="form-label">Date début</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="date_debut" name="date_debut" 
                                                       value="{% if request.GET.date_debut and request.GET.date_debut != 'None' %}{{ request.GET.date_debut }}{% endif %}" 
                                                       placeholder="DD/MM/YYYY" autocomplete="off">
                                                <button class="btn btn-outline-secondary" type="button" id="date_debut_btn">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </button>
                                            </div>
                                            <small class="form-text text-muted">Cliquez sur le calendrier ou tapez la date</small>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="date_fin" class="form-label">Date fin</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="date_fin" name="date_fin" 
                                                       value="{% if request.GET.date_fin and request.GET.date_fin != 'None' %}{{ request.GET.date_fin }}{% endif %}" 
                                                       placeholder="DD/MM/YYYY" autocomplete="off">
                                                <button class="btn btn-outline-secondary" type="button" id="date_fin_btn">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </button>
                                            </div>
                                            <small class="form-text text-muted">Cliquez sur le calendrier ou tapez la date</small>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">&nbsp;</label>
                                            <div class="d-flex gap-2 flex-wrap">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-search me-1"></i>Rechercher
                                                </button>
                                                <a href="{% url 'stock_debord:historique' %}" class="btn btn-secondary">
                                                    <i class="fas fa-times me-1"></i>Effacer
                                                </a>
                                                <a href="{% url 'stock_debord:export_historique_excel' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-success">
                                                    <i class="fas fa-file-excel me-1"></i>Excel
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date/Heure</th>
                                    <th>Type</th>
                                    <th>Référence</th>
                                    <th>Emplacement SM</th>
                                    <th>Nombre de Bacs</th>
                                    <th>Utilisateur</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in historique %}
                                <tr>
                                    <td>{{ entry.date_action|date:"d/m/Y H:i:s" }}</td>
                                    <td>
                                        {% if entry.type_action == 'entree' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-arrow-down me-1"></i>Entrée
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-arrow-up me-1"></i>Sortie
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ entry.reference.reference }}</strong></td>
                                    <td>{{ entry.reference.emplacement_sm }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ entry.nombre_bacs }}</span>
                                    </td>
                                    <td>{{ entry.utilisateur }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                        Aucun historique disponible
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Enhanced Pagination with new styles -->
                    {% if is_paginated %}
                        {% include 'stock_debord/partials/pagination.html' %}
                    {% else %}
                    <!-- Show total count when not paginated -->
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Affichage de toutes les {{ historique.count }} entrées d'historique
                        </small>
                    </div>
                    {% endif %}

                    <div class="mt-3">
                        <a href="{% url 'stock_debord:dashboard' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Retour au Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}